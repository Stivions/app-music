workflows:
  ios_offline_ipa:
    name: iOS Offline IPA
    max_build_duration: 60
    instance_type: mac_mini_m2

    environment:
      xcode: latest
      vars:
        # Ruta real a tu proyecto
        vars:
        XCODE_PROJECT: "offline-music-player/Offline/Offline.xcodeproj"
        XCODE_SCHEME: "Offline"

    scripts:
      - name: Show repo tree (debug)
        script: |
          pwd
          ls -la
          echo "----"
          ls -la offline-music-player || true
          echo "----"
          find . -maxdepth 4 -name "*.xcodeproj" -print

      - name: Build archive (no codesign)
        script: |
          set -e
          xcodebuild clean archive \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath build/Offline.xcarchive \
            CODE_SIGNING_ALLOWED=NO

      - name: Export IPA (tries best-effort)
        script: |
          set -e
          mkdir -p build/export

          cat > ExportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>destination</key>
            <string>export</string>
          </dict>
          </plist>
          PLIST

          # Esto puede fallar si Apple exige firma; por eso guardamos el .xcarchive como artifact sí o sí
          xcodebuild -exportArchive \
            -archivePath build/Offline.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist \
            CODE_SIGNING_ALLOWED=NO || true

    artifacts:
      - build/Offline.xcarchive
      - build/export/*.ipa
